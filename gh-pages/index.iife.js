var voiceCall=function(t){"use strict";function e(t,e,o,n,s){var g=t._events[e];g||(g=[],t._events[e]=g);var i=typeof o;"function"===i?g[g.length]={fn:o,once:n,ctx:s}:console.warn('Expect a function to bind "'.concat(e,'" event, but got ').concat(i," ").concat(o))}function o(t,o,n,s,g){return Array.isArray(o)?o.forEach((function(o){var i=typeof o;"string"!==i&&console.warn("Expect a string as event name, but got ".concat(i," ").concat(o)),e(t,o,n,s,g)})):e(t,o,n,s,g),t}function n(t,e,o,n){var s=t._events[e];if(s){var g=typeof o;"function"===g?t._events[e]=s.filter((function(t){return t.fn!==o||n&&!t.once})):console.warn('Expect a function to bind "'.concat(e,'" event, but got a ').concat(g))}}var s=function(){function t(t,e){this.target=e,this.currentTarget=e,this.isImmediatePropagationStopped=!0,"string"==typeof t?this.type=t:Object.assign(this,t)}return t.prototype.stopImmediatePropagation=function(){this.isImmediatePropagationStopped=!1},t.prototype.startImmediatePropagation=function(){this.isImmediatePropagationStopped=!0},t}(),g=function(){function t(){this._events=Object.create(null)}return t.prototype.on=function(t,e,n){return o(this,t,e,!1,n)},t.prototype.once=function(t,e,n){return o(this,t,e,!0,n)},t.prototype.off=function(t,e){return function(t,e,o){Array.isArray(e)?e.forEach((function(e){n(t,e,o,!1)})):n(t,e,o,!1)}(this,t,e),this},t.prototype.emit=function(t){var e=new s(t,this),o=e.type,g=this._events[o],i=0;if(!g)return i;for(var c=g.slice(0),r=c.length;i<r;i++){var a=c[i],I=a.fn,l=a.once,C=a.ctx;if(l&&n(this,o,I,l),I.call(void 0===C?this:C,e),!1===e.isImmediatePropagationStopped)break}return i},t.prototype.removeAllListeners=function(t){var e=this;switch(arguments.length){case 0:this._events=Object.create(null);break;case 1:Array.isArray(t)?t.forEach((function(t){delete e._events[t]})):delete this._events[t]}return this},t}();class i extends Error{constructor(t,e){super(t),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,Object.assign(this,e),this.name="SenderError"}}class c extends i{constructor(t,e){super(t,e),this.name="ClientError"}}class r extends i{constructor(t,e){super(t,e),this.name="Recorder"}}const a=window.AudioContext||window.webkitAudioContext,I=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];class l{constructor(t){this.audioContext=null,this.inputSource=null,this.inputStream=null,this.opts=t}start(){const{opts:t}=this,{sampleRate:e}=t,o=I.indexOf(e);return-1===o?Promise.reject(new r(`采样率应为 ${I.join(", ")} 其中之一`)):(n={audio:{sampleRate:e,autoGainControl:!1,echoCancellation:!0,noiseSuppression:!0}},navigator.mediaDevices?navigator.mediaDevices.getUserMedia(n).catch((()=>{throw new r("请确保录音设备正常，并允许浏览器获取录音权限，否则无法使用对讲功能")})):Promise.reject(new r("您的浏览器不支持获取用户设备，无法使用对讲功能，建议使用 Chrome 浏览器 ( 版本 >= 74 )"))).then((n=>{const s=new a({sampleRate:e}),g=s.createMediaStreamSource(n);this.inputStream=n,this.audioContext=s,this.inputSource=g;const{formatFlag:i}=t,c=function(t,e,o,n){let s=t<<4;return s|=e<<2,s|=o<<1,s|=n<<1,s}(i,t.sampleRateFlag,t.sampleBitsFlag,t.channelsFlag);return s.audioWorklet.addModule("data:application/javascript;base64,ZnVuY3Rpb24gc2VhcmNoKHZhbCwgdGFibGUpIHsKICBjb25zdCBzaXplID0gdGFibGUubGVuZ3RoOwogIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CiAgICBpZiAodmFsIDw9IHRhYmxlW2ldKSB7CiAgICAgIHJldHVybiBpOwogICAgfQogIH0KICByZXR1cm4gc2l6ZTsKfQoKY29uc3QgU0VHX0VORCA9IFsweEZGLCAweDFGRiwgMHgzRkYsIDB4N0ZGLCAweEZGRiwgMHgxRkZGLCAweDNGRkYsIDB4N0ZGRl07CgovKiAyJ3MgY29tcGxlbWVudCAoMTYtYml0IHJhbmdlKSAqLwpmdW5jdGlvbiBsaW5lYXIyYWxhdyhwY21fdmFsKSB7CiAgbGV0IG1hc2s7CiAgbGV0IGF2YWw7CgogIGlmIChwY21fdmFsID49IDApIHsKICAgIC8qIHNpZ24gKDd0aCkgYml0ID0gMSAqLwogICAgbWFzayA9IDB4RDU7CiAgfQogIGVsc2UgewogICAgLyogc2lnbiBiaXQgPSAwICovCiAgICBtYXNrID0gMHg1NTsKICAgIHBjbV92YWwgPSAtcGNtX3ZhbCAtIDg7CiAgfQoKICAvKiBDb252ZXJ0IHRoZSBzY2FsZWQgbWFnbml0dWRlIHRvIHNlZ21lbnQgbnVtYmVyLiAqLwogIGNvbnN0IHNlZyA9IHNlYXJjaChwY21fdmFsLCBTRUdfRU5EKTsKCiAgLyogQ29tYmluZSB0aGUgc2lnbiwgc2VnbWVudCwgYW5kIHF1YW50aXphdGlvbiBiaXRzLiAqLwoKICBpZiAoc2VnID49IDgpIHsgLyogb3V0IG9mIHJhbmdlLCByZXR1cm4gbWF4aW11bSB2YWx1ZS4gKi8KICAgIHJldHVybiAweDdGIF4gbWFzazsKICB9CgogIGF2YWwgPSBzZWcgPDwgNDsKICBpZiAoc2VnIDwgMikgewogICAgYXZhbCB8PSAocGNtX3ZhbCA+PiA0KSAmIDB4MGY7CiAgfQogIGVsc2UgewogICAgYXZhbCB8PSAocGNtX3ZhbCA+PiAoc2VnICsgMykpICYgMHgwZjsKICB9CgogIHJldHVybiBhdmFsIF4gbWFzazsKfQoKLyogMidzIGNvbXBsZW1lbnQgKDE2LWJpdCByYW5nZSkgKi8KZnVuY3Rpb24gbGluZWFyMnVsYXcocGNtX3ZhbCkgewogIGxldCBtYXNrOwoKICAvKiBHZXQgdGhlIHNpZ24gYW5kIHRoZSBtYWduaXR1ZGUgb2YgdGhlIHZhbHVlLiAqLwogIGlmIChwY21fdmFsIDwgMCkgewogICAgcGNtX3ZhbCA9IDB4ODQgLSBwY21fdmFsOwogICAgbWFzayA9IDB4N0Y7CiAgfQogIGVsc2UgewogICAgcGNtX3ZhbCArPSAweDg0OwogICAgbWFzayA9IDB4RkY7CiAgfQoKICAvKiBDb252ZXJ0IHRoZSBzY2FsZWQgbWFnbml0dWRlIHRvIHNlZ21lbnQgbnVtYmVyLiAqLwogIGNvbnN0IHNlZyA9IHNlYXJjaChwY21fdmFsLCBTRUdfRU5EKTsKCiAgLyoKICAqIENvbWJpbmUgdGhlIHNpZ24sIHNlZ21lbnQsIHF1YW50aXphdGlvbiBiaXRzOwogICogYW5kIGNvbXBsZW1lbnQgdGhlIGNvZGUgd29yZC4KICAqLwogIGlmIChzZWcgPj0gOCkgeyAvKiBvdXQgb2YgcmFuZ2UsIHJldHVybiBtYXhpbXVtIHZhbHVlLiAqLwogICAgcmV0dXJuICgweDdGIF4gbWFzayk7CiAgfQoKICBjb25zdCB1dmFsID0gKHNlZyA8PCA0KSB8ICgocGNtX3ZhbCA+PiAoc2VnICsgMykpICYgMHgwZik7CiAgcmV0dXJuIHV2YWwgXiBtYXNrOwp9CgpmdW5jdGlvbiBmMzJUb1U4KGYzMikgewogIHJldHVybiBmMzIgPCAwID8gZjMyICogMHg4MDAwIDogZjMyICogMHg3RkZGOwp9CgpmdW5jdGlvbiBmbG9hdDMyVG9VaW50OChmbG9hdDMyQXJyYXksIGNiKSB7CiAgY29uc3QgbGVuID0gZmxvYXQzMkFycmF5Lmxlbmd0aDsKICBjb25zdCB1aW50OEFycmF5ID0gbmV3IFVpbnQ4QXJyYXkobGVuKTsKCiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgdWludDhBcnJheVtpXSA9IGNiKGYzMlRvVTgoTWF0aC5tYXgoLTEsIE1hdGgubWluKDEsIGZsb2F0MzJBcnJheVtpXSkpKSk7CiAgfQoKICByZXR1cm4gdWludDhBcnJheTsKfQoKZnVuY3Rpb24gZW5jb2RlUENNKGZsb2F0MzJBcnJheSwgdHlwZSkgewogIHN3aXRjaCAodHlwZSkgewogICAgY2FzZSA3OiAvLyBnNzExYQogICAgICByZXR1cm4gZmxvYXQzMlRvVWludDgoZmxvYXQzMkFycmF5LCBsaW5lYXIyYWxhdyk7CgogICAgY2FzZSA4OiAvLyBnNzExdQogICAgICByZXR1cm4gZmxvYXQzMlRvVWludDgoZmxvYXQzMkFycmF5LCBsaW5lYXIydWxhdyk7CiAgfQp9CgovLyDliJvlu7rpn7PpopFUYWcKZnVuY3Rpb24gY3JlYXRlRmx2QXVkaW9UYWcoYXVkaW9EYXRhLCB0aW1lc3RhbXAsIGZvcm1hdFZhbHVlKSB7CiAgLy8g6Z+z6aKR5pWw5o2u5aSn5bCPICsg5Zu65a6a6Z+z6aKR5qC85byPIDEgKyDpn7PpopHlpLTnsbvlnosgMQogIGNvbnN0IGRhdGFTaXplID0gYXVkaW9EYXRhLmxlbmd0aCArIDI7CgogIC8vIFRhZ+Wkp+Wwj++8mmhlYWRlciArIGRhdGEKICBjb25zdCB0YWdTaXplID0gMTEgKyBkYXRhU2l6ZTsKCiAgLy8gdGFnU2l6ZSArIFByZXZpb3VzVGFnU2l6ZQogIGNvbnN0IHRhZyA9IG5ldyBVaW50OEFycmF5KHRhZ1NpemUgKyA0KTsKCiAgLy8gPT09PSBzdGFydCBhdWRpbyB0YWcgaGVhZGVyCiAgLy8g6Z+z6aKRVGFn57G75Z6L77yMMHgwOOihqOekuumfs+mikQogIHRhZ1swXSA9IDB4MDg7CgogIC8vIOaVsOaNruWkp+WwjwogIHRhZ1sxXSA9IChkYXRhU2l6ZSA+PiAxNikgJiAweEZGOwogIHRhZ1syXSA9IChkYXRhU2l6ZSA+PiA4KSAmIDB4RkY7CiAgdGFnWzNdID0gZGF0YVNpemUgJiAweEZGOwoKICB0YWdbNF0gPSAodGltZXN0YW1wID4+IDE2KSAmIDB4RkY7IC8vIOaXtumXtOaIs+S9jjjkvY0KICB0YWdbNV0gPSAodGltZXN0YW1wID4+IDgpICYgMHhGRjsgLy8g5pe26Ze05oiz5LitOOS9jQogIHRhZ1s2XSA9IHRpbWVzdGFtcCAmIDB4RkY7IC8vIOaXtumXtOaIs+mrmDjkvY0KCiAgLy8g5pe26Ze05oiz5omp5bGVCiAgdGFnWzddID0gKHRpbWVzdGFtcCA+PiAyNCkgJiAweEZGOwoKICAvLyBTdHJlYW1JRO+8jOWni+e7iOS4ujAKICB0YWdbOF0gPSAweDAwOwogIHRhZ1s5XSA9IDB4MDA7CiAgdGFnWzEwXSA9IDB4MDA7CiAgLy8gPT09PSBlbmQgYXVkaW8gdGFnIGhlYWRlcgoKICAvLyDpn7PpopHmoLzlvI8gMTAwMCAxMTEwIG9yIDAxMTEgMTExMAogIHRhZ1sxMV0gPSBmb3JtYXRWYWx1ZSAmIDB4RkY7CgogIC8vIDA6IGhlYWRlcjsgMTogYm9keQogIHRhZ1sxMl0gPSAweDAxOwogIHRhZy5zZXQoYXVkaW9EYXRhLCAxMyk7CgogIGxldCBvZmZzZXQgPSAxMyArIGF1ZGlvRGF0YS5sZW5ndGg7CgogIC8vIFByZXZpb3VzVGFnU2l6ZQogIHRhZ1tvZmZzZXQrK10gPSAodGFnU2l6ZSA+PiAyNCkgJiAweEZGOwogIHRhZ1tvZmZzZXQrK10gPSAodGFnU2l6ZSA+PiAxNikgJiAweEZGOwogIHRhZ1tvZmZzZXQrK10gPSAodGFnU2l6ZSA+PiA4KSAmIDB4RkY7CiAgdGFnW29mZnNldCsrXSA9IHRhZ1NpemUgJiAweEZGOwoKICByZXR1cm4gdGFnOwp9CgpmdW5jdGlvbiBtZXJnZUNoYW5uZWxzKGZsb2F0MzJJbnB1dHMpIHsKICBjb25zdCBpbnB1dENoYW5uZWxzID0gZmxvYXQzMklucHV0c1swXTsKCiAgY29uc3QgbnVtQ2hhbm5lbHMgPSBpbnB1dENoYW5uZWxzLmxlbmd0aDsKICBpZiAoIW51bUNoYW5uZWxzKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CgogIGNvbnN0IG51bVNhbXBsZXMgPSBpbnB1dENoYW5uZWxzWzBdLmxlbmd0aDsKICBjb25zdCBtZXJnZWRDaGFubmVsID0gbmV3IEZsb2F0MzJBcnJheShudW1TYW1wbGVzKTsKCiAgZm9yIChsZXQgc2FtcGxlSWR4ID0gMDsgc2FtcGxlSWR4IDwgbnVtU2FtcGxlczsgc2FtcGxlSWR4KyspIHsKICAgIGxldCBtZXJnZWRTYW1wbGUgPSAwOwoKICAgIC8vIOWkmuWjsOmBk+aVsOaNruWQiOW5tgogICAgZm9yIChsZXQgY2hhbm5lbElkeCA9IDA7IGNoYW5uZWxJZHggPCBudW1DaGFubmVsczsgY2hhbm5lbElkeCsrKSB7CiAgICAgIG1lcmdlZFNhbXBsZSArPSBpbnB1dENoYW5uZWxzW2NoYW5uZWxJZHhdW3NhbXBsZUlkeF07CiAgICB9CiAgICBtZXJnZWRDaGFubmVsW3NhbXBsZUlkeF0gPSBtZXJnZWRTYW1wbGUgLyBudW1DaGFubmVsczsKICB9CgogIHJldHVybiBtZXJnZWRDaGFubmVsOwp9CgpjbGFzcyBNeVByb2Nlc3NvciBleHRlbmRzIEF1ZGlvV29ya2xldFByb2Nlc3NvciB7CiAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgc3VwZXIob3B0aW9ucyk7CgogICAgT2JqZWN0LmFzc2lnbih0aGlzLCBvcHRpb25zLnByb2Nlc3Nvck9wdGlvbnMpOwogICAgdGhpcy50aW1lc3RhbXAgPSAwOwogICAgdGhpcy5wb3N0ID0gdGhpc1t0aGlzLnNhbXBsZVR5cGVdOwogIH0KCiAgcHJvY2VzcyhpbnB1dHMsIG91dHB1dHMpIHsKICAgIC8vIGxldCBkYXRhID0gaW5wdXRzWzBdWzBdOwogICAgY29uc3QgZGF0YSA9IG1lcmdlQ2hhbm5lbHMoaW5wdXRzLCBvdXRwdXRzKTsKICAgIGlmICghZGF0YSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICB0aGlzLnBvc3QoZGF0YSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIHBjbShkYXRhKSB7CiAgICB0aGlzLnBvcnQucG9zdE1lc3NhZ2UoZGF0YSwgW2RhdGEuYnVmZmVyXSk7CiAgfQoKICBnNzExeChkYXRhKSB7CiAgICBkYXRhID0gZW5jb2RlUENNKGRhdGEsIHRoaXMuZm9ybWF0RmxhZyk7CiAgICB0aGlzLnBvcnQucG9zdE1lc3NhZ2UoZGF0YSwgW2RhdGEuYnVmZmVyXSk7CiAgfQoKICBmbHYoZGF0YSkgewogICAgY29uc3QgYXVkaW9EdXJhdGlvbiA9IGRhdGEubGVuZ3RoIC8gKDIgKiB0aGlzLnNhbXBsZVJhdGUpOwogICAgY29uc3QgeyB0aW1lc3RhbXAgfSA9IHRoaXM7CgogICAgZGF0YSA9IGNyZWF0ZUZsdkF1ZGlvVGFnKAogICAgICBlbmNvZGVQQ00oZGF0YSwgdGhpcy5mb3JtYXRGbGFnKSwKICAgICAgdGltZXN0YW1wLAogICAgICB0aGlzLmZvcm1hdFZhbHVlCiAgICApOwoKICAgIHRoaXMucG9ydC5wb3N0TWVzc2FnZShkYXRhLCBbZGF0YS5idWZmZXJdKTsKCiAgICB0aGlzLnRpbWVzdGFtcCA9IHRpbWVzdGFtcCArIE1hdGguZmxvb3IoYXVkaW9EdXJhdGlvbiAqIDEwMDApOwogIH0KfQoKcmVnaXN0ZXJQcm9jZXNzb3IoJ2NvbGxlY3Rpb25Qcm9jZXNzb3InLCBNeVByb2Nlc3Nvcik7Cg==").then((()=>{const t=new AudioWorkletNode(s,"collectionProcessor",{processorOptions:{formatValue:c,formatFlag:i,sampleRate:e,sampleType:"flv"}});t.port.onmessage=t=>{this.onData(t.data)},g.connect(t),t.connect(s.destination),this.onData(function(t,e){const o=new Uint8Array(32);let n=function(t,e){return t[e++]=70,t[e++]=76,t[e++]=86,t[e++]=1,t[e++]=4,t[e++]=0,t[e++]=0,t[e++]=0,t[e++]=9,e}(o,0);return o[n++]=0,o[n++]=0,o[n++]=0,o[n++]=0,n=function(t,e,o,n){return t[e++]=8,t[e++]=0,t[e++]=0,t[e++]=4,t[e++]=0,t[e++]=0,t[e++]=0,t[e++]=0,t[e++]=0,t[e++]=0,t[e++]=0,t[e++]=255&o,t[e++]=0,t[e++]=n<<4&255,t[e++]=0,e}(o,n,t,e),o[n++]=0,o[n++]=0,o[n++]=0,o[n++]=15,o}(c,o))}))})).catch((t=>{const e=()=>{throw t};return this.stop().then(e,e)}));var n}stop(){const{inputStream:t,inputSource:e,audioContext:o}=this;if(e&&(e.disconnect(),this.inputSource=null),t&&(t.getAudioTracks().forEach((t=>{"live"===t.readyState&&t.stop()})),this.inputStream=null),o){const t=()=>{this.audioContext=null};return o.close().then(t,t)}return Promise.resolve()}onData(t){console.info("receive data:",t)}}class C{constructor(){this.socket=null}connect(t,e){return new Promise(((o,n)=>{const s=new WebSocket(t,e);console.info(`Connecting: ${t}.`),s.onopen=()=>{console.info(`Connected WebSocket server, readyState is ${s.readyState}.`),this.socket=s;const t=()=>{console.info("WebSocket connection closed."),this.socket=null,this.onDisconnect()};s.onerror=()=>{const{readyState:e}=s;switch(console.error(`WebSocket disconnected, readyState is ${e}.`),e){case 0:case 1:this.disconnect();break;case 2:case 3:t()}},o()},s.onerror=t=>{const e=new c("Could not connect WebSocket server.");console.error(e,t),this.socket=null,n(e)}}))}send(t){const{socket:e}=this;e&&1===e.readyState&&e.send(t)}disconnect(){const{socket:t}=this;return new Promise((e=>{if(!t)return console.warn("WebSocket has been closed."),void e();const o=()=>{t.removeEventListener("close",o),e()};switch(t.readyState){case 0:case 1:t.addEventListener("close",o),t.close();break;case 2:t.addEventListener("close",o);break;case 3:e()}}))}onDisconnect(){}}return t.RUNNING=2,t.START=1,t.STOP=3,t.Sender=class extends g{constructor(t){super(),this._installedPlugins=[],this._state=0,t=Object.assign({bufferSize:4096,sampleRate:8e3,formatFlag:7,sampleBitsFlag:1,sampleRateFlag:3,channelsFlag:0},t),this.opts=t;const e=new l(t),o=new C;this.recorder=e,this.client=o,o.onDisconnect=()=>{this._state=3,e.stop().then((()=>{this._state=0,this.emit("disconnect")}))}}get state(){return this._state}get audioContext(){return this.recorder.audioContext}get inputSource(){return this.recorder.inputSource}start(t,e){switch(this._state){case 1:return Promise.reject(new i("Sender is starting."));case 2:return Promise.reject(new i("Sender is running."));case 3:return new Promise(((o,n)=>{this.once("stop",(()=>{this.start(t,e).then(o,n)}))}))}this._state=1;const{opts:o,client:n,recorder:s}=this;t=t||o.url,e=e||o.protocols;const g="function"==typeof t?t():t;return Promise.resolve(g).then((t=>{if(t)return n.connect(t,e).then((()=>{s.onData=t=>{n.send(t),this.emit({type:"data",data:t})}}));s.onData=t=>{this.emit({type:"data",data:t})}})).then((()=>s.start())).then((()=>{this._state=2,this.emit("start")})).catch((t=>{throw this._state=0,this.emit({type:"error",error:t}),t}))}stop(){switch(this._state){case 3:return Promise.reject(new i("Sender is stopping."));case 0:return console.info("Sender is not running."),Promise.resolve()}this._state=3;const{client:t}=this;return Promise.all([t.socket&&t.disconnect(),this.recorder.stop()]).then((()=>{this._state=0,this.emit("stop")}))}dispose(){return this.stop().then((()=>{this.emit("dispose")}))}use(t,...e){const o=this._installedPlugins;return o.indexOf(t)>-1?console.warn("Plugin has already been applied to target sender."):"function"==typeof t?(o.push(t),t(this,...e)):console.warn("A plugin must be a function."),this}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),t}({});
